<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ryan.mapper.SearchMapper">
<select id="bookList" resultType="com.ryan.domain.book.EBookVO">
	SELECT e.* FROM 
	(SELECT DISTINCT book_num
	FROM (
	SELECT * FROM eBook
	WHERE 
	<choose>
			<when test="param1.equals('BOOK_TITLE')" >
				<foreach collection="param2" index="index" item="search" separator="or">
					BOOK_TITLE LIKE  '%'||#{search}||'%'
				</foreach>
			</when>
			<when test="param1.equals('BOOK_WRITER')" >
				<foreach collection="param2" index="index" item="search" separator="or" >
					BOOK_WRITER LIKE '%'||#{search}||'%'
				</foreach>
			</when>
			<when test="param1.equals('BOOK_PUBLISHER')" >
				<foreach collection="param2" index="index" item="search" separator="or" >
					BOOK_PUBLISHER LIKE '%'||#{search }||'%'
				</foreach>
			</when>
		</choose>
		AND BOOK_EXISTENCE LIKE 1
		ORDER BY book_title
	)) a
	JOIN eBook e ON a.book_num=e.book_num
</select>

<select id="ebookList" resultType="com.ryan.domain.book.EBookVO">
	SELECT e.* FROM 
	(SELECT DISTINCT book_num
	FROM (
	SELECT * FROM eBook
	WHERE 
	<choose>
			<when test="param1.equals('BOOK_TITLE')" >
				<foreach collection="param2" index="index" item="search" separator="or">
					BOOK_TITLE LIKE  '%'||#{search}||'%'
				</foreach>
			</when>
			<when test="param1.equals('BOOK_WRITER')" >
				<foreach collection="param2" index="index" item="search" separator="or" >
					BOOK_WRITER LIKE '%'||#{search}||'%'
				</foreach>
			</when>
			<when test="param1.equals('BOOK_PUBLISHER')" >
				<foreach collection="param2" index="index" item="search" separator="or" >
					BOOK_PUBLISHER LIKE '%'||#{search }||'%'
				</foreach>
			</when>
		</choose>
		ORDER BY book_title
	)) a
	JOIN eBook e ON a.book_num=e.book_num
</select>

<!--@@@@@@@@@@@@@@@@@@@@@@@@@@@ 이 밑으로 제가 수정 좀 했습니다.   @@@@@@@@@@@@@@@@@@@@@@@@@@@@-->
	<!-- ebook 검색 -->
	<select resultType="com.ryan.domain.book.EBookVO" id="searchEbook" >
		SELECT * FROM EBOOK WHERE
		<choose>
			<when test="param1.equals('BOOK_TITLE')" >
				<foreach collection="param2" index="index" item="search" separator="or">
					BOOK_TITLE LIKE  '%'||#{search}||'%'
				</foreach>
			</when>
			<when test="param1.equals('BOOK_WRITER')" >
				<foreach collection="param2" index="index" item="search" separator="or" >
					BOOK_WRITER LIKE '%'||#{search}||'%'
				</foreach>
			</when>
			<when test="param1.equals('BOOK_PUBLISHER')" >
				<foreach collection="param2" index="index" item="search" separator="or" >
					BOOK_PUBLISHER LIKE '%'||#{search }||'%'
				</foreach>
			</when>
		</choose>
	</select>
	<!-- 종이책 검색 -->
	<select resultType="com.ryan.domain.book.EBookVO" id="searchPaperbook" >
		SELECT * FROM EBOOK WHERE
		<choose>
			<when test="param1.equals('BOOK_TITLE')" >
				<foreach collection="param2" index="index" item="search" separator="or">
					BOOK_TITLE LIKE  '%'||#{search}||'%'
				</foreach>
			</when>
			<when test="param1.equals('BOOK_WRITER')" >
				<foreach collection="param2" index="index" item="search" separator="or" >
					BOOK_WRITER LIKE '%'||#{search}||'%'
				</foreach>
			</when>
			<when test="param1.equals('BOOK_PUBLISHER')" >
				<foreach collection="param2" index="index" item="search" separator="or" >
					BOOK_PUBLISHER LIKE '%'||#{search }||'%'
				</foreach>
			</when>
		</choose>
		AND BOOK_EXISTENCE LIKE 1
	</select>
	<!-- ebook page -->
	<select resultType="com.ryan.domain.book.EBookVO" id="searchEbookPage" >
		WITH result AS
		(SELECT ROWNUM num, EBOOK.* FROM EBOOK WHERE
		<choose>
			<when test="param1.equals('BOOK_TITLE')" >
				<foreach collection="param2" index="index" item="search" separator="or">
					BOOK_TITLE LIKE  '%'||#{search}||'%'
				</foreach>
			</when>
			<when test="param1.equals('BOOK_WRITER')" >
				<foreach collection="param2" index="index" item="search" separator="or" >
					BOOK_WRITER LIKE '%'||#{search}||'%'
				</foreach>
			</when>
			<when test="param1.equals('BOOK_PUBLISHER')" >
				<foreach collection="param2" index="index" item="search" separator="or" >
					BOOK_PUBLISHER LIKE '%'||#{search }||'%'
				</foreach>
			</when>
		</choose>)
		SELECT * FROM result
		WHERE num BETWEEN ((${param3 }*12)-11) AND (${param3 }*12)
	</select>
	<!-- 종이책 page -->
	<select resultType="com.ryan.domain.book.EBookVO" id="searchPaperbookPage" >
		WITH result AS
		(SELECT ROWNUM num, EBOOK.* FROM EBOOK WHERE
		<choose>
			<when test="param1.equals('BOOK_TITLE')" >
				<foreach collection="param2" index="index" item="search" separator="or">
					BOOK_TITLE LIKE  '%'||#{search}||'%'
				</foreach>
			</when>
			<when test="param1.equals('BOOK_WRITER')" >
				<foreach collection="param2" index="index" item="search" separator="or" >
					BOOK_WRITER LIKE '%'||#{search}||'%'
				</foreach>
			</when>
			<when test="param1.equals('BOOK_PUBLISHER')" >
				<foreach collection="param2" index="index" item="search" separator="or" >
					BOOK_PUBLISHER LIKE '%'||#{search }||'%'
				</foreach>
			</when>
		</choose>
		AND BOOK_EXISTENCE LIKE 1)
		SELECT * FROM result
		WHERE num BETWEEN ((${param3 }*12)-11) AND (${param3 }*12)
	</select>
	<!-- 전체 책 출력 -->
	<select id="getFilterSearch" resultType="com.ryan.domain.book.EBookVO">
		WITH result as
		(SELECT e.* FROM ebook e
		<choose>
			<when test="genre == 0" >
			</when>
			<when test="genre != null">
				, first_category f , second_category s
				<where>
					e.category_num = s.category_num and s.first_num = f.first_num
					and f.first_num = #{genre }
				</where>
			</when>
			<when test="sub_genre != null">
				, second_category s
				<where>
					e.category_num = s.category_num
					and s.category_num = #{sub_genre }
				</where>
			</when>
		</choose>
		<choose>
			<when test="sort == null" >
				ORDER BY book_title
			</when>
			<when test="sort == ''">
				ORDER BY book_title
			</when>
			<when test="sort == 'title'">
				ORDER BY book_title
			</when>
			<when test="sort == 'author'" >
				ORDER BY book_writer
			</when>
			<when test="sort == 'publisher'" >
				ORDER BY book_publisher
			</when>
		</choose>
		),
		rowresult AS
		(SELECT ROWNUM num, r.* FROM result r)
		SELECT * FROM rowresult
		<choose>
			<when test="page == null" >
				WHERE num BETWEEN 1 AND 12
			</when>
			<when test="page != null" >
				WHERE num BETWEEN TO_NUMBER(#{page })*12-11 AND TO_NUMBER(#{page })*12
			</when>
		</choose>
	</select>
	<!-- 데이터 갯수 카운트 -->
	<select id="getFilterSearchCount" resultType="com.ryan.domain.book.EBookVO">
		SELECT ROWNUM num, e.* FROM ebook e
		<choose>
			<when test="genre == 0" >
			</when>
			<when test="genre != null">
				, first_category f , second_category s
				<where>
					e.category_num = s.category_num and s.first_num = f.first_num
					and f.first_num = #{genre }
				</where>
			</when>
			<when test="sub_genre != null">
				, second_category s
				<where>
					e.category_num = s.category_num
					and s.category_num = #{sub_genre }
				</where>
			</when>
		</choose>
	</select>
</mapper>